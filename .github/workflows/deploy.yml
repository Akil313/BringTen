name: Deploy to Droplet Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy App
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          PUBLIC_API_URL: ${{ secrets.PUBLIC_API_URL }}
          API_URL: ${{ secrets.API_URL }}
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            cd /home/github/projects/BringTen

            git pull origin main

            echo "Writing bring-ten/.env.production from one secret"
            rm -f bring-ten/.env.production
            {
              echo PUBLIC_API_URL=$PUBLIC_API_URL
              echo API_URL=$API_URL
            } > bring-ten/.env.production

            docker compose down
            docker compose --env-file ./bring-ten/.env.production up -d --build
